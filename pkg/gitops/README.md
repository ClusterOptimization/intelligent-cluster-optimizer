# GitOps Integration

The GitOps package enables exporting resource optimization recommendations as GitOps-compatible patches instead of applying them directly to the cluster.

## Features

- **Kustomize Support**: Generate strategic merge patches or JSON 6902 patches
- **Helm Support**: Generate values.yaml overrides
- **Format Flexibility**: Export to multiple formats simultaneously
- **Validation**: Comprehensive input validation
- **Resource Formatting**: Automatic conversion to Kubernetes resource formats (CPU: 100m/1.5, Memory: 512Mi/1Gi)

## Supported Workload Types

- Deployment
- StatefulSet
- DaemonSet
- ReplicaSet
- Pod
- CronJob
- Job

## Export Formats

### 1. Kustomize Strategic Merge Patches

Generates YAML patches that Kustomize can merge with base resources.

**Use Case**: GitOps workflows with Kustomize-based deployments

### 2. Kustomize JSON 6902 Patches

Generates JSON Patch (RFC 6902) operations for precise modifications.

**Use Case**: Complex modifications requiring specific path targeting

### 3. Helm Values

Generates values.yaml overrides for Helm charts.

**Use Case**: GitOps workflows with Helm-based deployments

## Usage

### Basic Export

```go
package main

import (
    "fmt"
    "intelligent-cluster-optimizer/pkg/gitops"
)

func main() {
    // Create exporter
    exporter := gitops.NewExporter()

    // Define recommendations
    recommendations := []gitops.ResourceRecommendation{
        {
            Namespace:         "production",
            Name:              "api-server",
            Kind:              "Deployment",
            ContainerName:     "api",
            RecommendedCPU:    500,      // 500m
            RecommendedMemory: 536870912, // 512Mi
            SetLimits:         false,
            Confidence:        85.5,
            Reason:            "Based on P95 usage",
        },
    }

    // Export as Kustomize patches
    config := gitops.ExportConfig{
        Format:     gitops.FormatKustomize,
        OutputPath: "./kustomize/overlays/optimized",
    }

    result, err := exporter.Export(recommendations, config)
    if err != nil {
        panic(err)
    }

    fmt.Printf("Generated %d files\n", len(result.Files))
    for filename := range result.Files {
        fmt.Printf("  - %s\n", filename)
    }
}
```

### Export to Multiple Formats

```go
formats := []gitops.ExportFormat{
    gitops.FormatKustomize,
    gitops.FormatHelm,
}

for _, format := range formats {
    config := gitops.ExportConfig{
        Format:     format,
        OutputPath: fmt.Sprintf("./gitops/%s", format),
    }

    result, err := exporter.Export(recommendations, config)
    if err != nil {
        log.Printf("Failed to export %s: %v", format, err)
        continue
    }

    log.Printf("Exported %s: %d files", format, len(result.Files))
}
```

### Preview Without Writing Files

```go
// Export to string for preview
output, err := gitops.ExportToString(recommendations, gitops.FormatKustomize)
if err != nil {
    panic(err)
}

fmt.Println(output)
```

### With Resource Limits

```go
recommendation := gitops.ResourceRecommendation{
    Namespace:         "database",
    Name:              "postgres",
    Kind:              "StatefulSet",
    ContainerName:     "postgres",
    RecommendedCPU:    2000,              // 2 cores
    RecommendedMemory: 4294967296,        // 4Gi
    SetLimits:         true,              // Set limits = requests
    Confidence:        95.0,
    Reason:            "Based on 7 days P99 usage",
}
```

## Output Examples

### Kustomize Strategic Merge Patch

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-server
  namespace: production
spec:
  template:
    spec:
      containers:
      - name: api
        resources:
          requests:
            cpu: 500m
            memory: 512Mi
```

### Kustomize JSON 6902 Patch

```json
[
  {
    "op": "replace",
    "path": "/spec/template/spec/containers/0/resources/requests/cpu",
    "value": "500m"
  },
  {
    "op": "replace",
    "path": "/spec/template/spec/containers/0/resources/requests/memory",
    "value": "512Mi"
  }
]
```

### Helm Values

```yaml
# Generated by Intelligent Cluster Optimizer
# This file contains resource recommendations

api_server:
  resources:
    requests:
      cpu: 500m
      memory: 512Mi
  optimizer:
    confidence: 85.5%
    reason: Based on P95 usage
```

### Generated Kustomization File

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
patches:
- patch-production-api-server-0.yaml
- patch-database-postgres-0.yaml
```

## Resource Format Conversion

The package automatically converts internal representations to Kubernetes formats:

**CPU:**
- `< 1000m` → millicores format (`100m`, `500m`, `999m`)
- `>= 1000m` → cores format (`1.00`, `1.50`, `2.00`)

**Memory:**
- `< 1Ki` → bytes (`512`, `1023`)
- `>= 1Ki` → Ki format (`1Ki`, `512Ki`)
- `>= 1Mi` → Mi format (`1Mi`, `512Mi`)
- `>= 1Gi` → Gi format (`1Gi`, `4Gi`)
- `>= 1Ti` → Ti format (`1Ti`)

## Validation

The package validates:
- Required fields (namespace, name, kind, container name)
- Positive resource values (CPU > 0, Memory > 0)
- Valid export formats
- Action-specific parameters

## Error Handling

```go
result, err := exporter.Export(recommendations, config)
if err != nil {
    log.Printf("Export failed: %v", err)
    return
}

// Check for partial failures
if len(result.Errors) > 0 {
    log.Printf("Encountered %d errors during export", len(result.Errors))
    for _, err := range result.Errors {
        log.Printf("  - %v", err)
    }
}
```

## GitOps Workflow Integration

### With ArgoCD

1. Export recommendations to a Git repository directory
2. Commit and push changes
3. ArgoCD detects changes and syncs

```bash
# Export optimizations
./optimizer export --format kustomize --output ./k8s/overlays/optimized

# Commit to Git
git add k8s/overlays/optimized
git commit -m "Apply optimizer recommendations"
git push

# ArgoCD syncs automatically
```

### With Flux

1. Export recommendations to a Git repository
2. Flux detects changes via GitRepository source
3. Kustomization applies patches

```bash
# Export optimizations
./optimizer export --format kustomize --output ./clusters/production/optimizations

# Commit to Git
git add clusters/production/optimizations
git commit -m "Optimize resource requests"
git push

# Flux reconciles automatically
```

## Testing

The package includes comprehensive tests covering:
- All export formats
- Resource validation
- Format conversion
- Error handling
- Edge cases (empty recommendations, invalid values)
- File I/O operations

Run tests:

```bash
go test ./pkg/gitops/... -v
go test ./pkg/gitops/... -cover
```

## Thread Safety

All generators are thread-safe and can be used concurrently:

```go
var wg sync.WaitGroup
for _, rec := range recommendations {
    wg.Add(1)
    go func(r gitops.ResourceRecommendation) {
        defer wg.Done()
        patch, err := gen.GenerateStrategicMerge(r)
        // ... handle result
    }(rec)
}
wg.Wait()
```

## Performance

- **Memory**: Minimal allocation, YAML/JSON marshaling only
- **CPU**: Fast format conversion with precompiled regexes
- **I/O**: Efficient batch file writing

## Limitations

- Container index assumed to be 0 for JSON 6902 patches (in production, would need to discover index)
- Git operations interface defined but not implemented (requires external Git client)
- Pull request creation requires GitHub API integration (not included)

## Future Enhancements

- Full Git operations implementation with go-git library
- GitHub/GitLab/Bitbucket PR creation
- Support for PodTemplate, ReplicationController
- Custom patch templates
- Diff generation against current state
- Automatic conflict resolution
